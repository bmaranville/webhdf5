<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
    <title>Emscripten-Generated Code</title>
  </head>
  <body>
    <div class="spinner" id="spinner"></div>
    <div class="emscripten" id="status">Downloading...</div>
    <div class="emscripten">
      <progress hidden id="progress" max="100" value="0"> </progress>
    </div>
    <textarea id="output" rows="8"> </textarea>
    <input type="file" id="datafile" onchange="loadData()" />
    <script>
      var statusElement = document.getElementById("status"),
        progressElement = document.getElementById("progress"),
        spinnerElement = document.getElementById("spinner"),
        Module = {
          noInitialRun: true,
          noExitRuntime: true,
          preRun: [],
          postRun: [],
          print: (function() {
            var t = document.getElementById("output");
            return (
              t && (t.value = ""),
              function(e) {
                1 < arguments.length &&
                  (e = Array.prototype.slice.call(arguments).join(" ")),
                  console.log(e),
                  t && ((t.value += e + "\n"), (t.scrollTop = t.scrollHeight));
              }
            );
          })(),
          printErr: function(e) {
            1 < arguments.length &&
              (e = Array.prototype.slice.call(arguments).join(" ")),
              console.error(e);
          },
          setStatus: function(e) {
            if (
              (Module.setStatus.last ||
                (Module.setStatus.last = { time: Date.now(), text: "" }),
              e !== Module.setStatus.last.text)
            ) {
              var t = e.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/),
                n = Date.now();
              (t && n - Module.setStatus.last.time < 30) ||
                ((Module.setStatus.last.time = n),
                (Module.setStatus.last.text = e),
                t
                  ? ((e = t[1]),
                    (progressElement.value = 100 * parseInt(t[2])),
                    (progressElement.max = 100 * parseInt(t[4])),
                    (progressElement.hidden = !1),
                    (spinnerElement.hidden = !1))
                  : ((progressElement.value = null),
                    (progressElement.max = null),
                    (progressElement.hidden = !0),
                    e || (spinnerElement.style.display = "none")),
                (statusElement.innerHTML = e));
            }
          },
          totalDependencies: 0,
          monitorRunDependencies: function(e) {
            (this.totalDependencies = Math.max(this.totalDependencies, e)),
              Module.setStatus(
                e
                  ? "Preparing... (" +
                      (this.totalDependencies - e) +
                      "/" +
                      this.totalDependencies +
                      ")"
                  : "All downloads complete."
              );
          }
        };
      Module.setStatus("Downloading..."),
        (window.onerror = function(e) {
          Module.setStatus("Exception thrown, see JavaScript console"),
            (spinnerElement.style.display = "none"),
            (Module.setStatus = function(e) {
              e && Module.printErr("[post-exception status] " + e);
            });
        });
      function loadData() {
          var file_input = document.getElementById('datafile');
          var file = file_input.files[0]; // only one file allowed
          let datafilename = file.name;
          let reader = new FileReader();
          reader.onloadend = function(evt) { 
            let data = evt.target.result;
            //var f = new hdf5.File(barr, datafilename);
            //window.f = f;
            //HDFHandler(datafilename, f);
            //$("span#loaded_file").text(datafilename);
            // Store the file
            //let filename = 'favicon.ico';
            
            
            /*
            let stream = FS.open(datafilename, 'w+');
            FS.write(stream, data, 0, data.byteLength, 0);
            FS.close(stream);
            */
            
            FS.writeFile('data.h5', new Uint8Array(data));

            // Call WebAssembly/C++ to process the file
            //console.log(Module.processFile(filename));
            console.log('file loaded', datafilename);
          }
          reader.readAsArrayBuffer(file);
          
          file_input.value = "";
      }
      function load_file(filename) {
        let fid = Module.ccall("H5Fopen", "bigint", ["string", "number", "bigint"], [filename, 0, 0n]);
        return fid;
      }
      function get_keys(file_id, groupname) {
        let decoder = new TextDecoder();
        let num_keys = Module.ccall("num_keys", "bigint", ["bigint", "string"], [file_id, groupname]);
        let ordered = Module.ccall("has_creation_order", "boolean", ["bigint", "string"], [file_id, groupname]);
        let ordering = (ordered) ? 1 : 0;
        keys = [];
        for (let i=0n; i<num_keys; i++) {
          let name_length = Module.ccall("H5Lget_name_by_idx", "number", ["bigint", "string", "number", "number", "bigint", "bigint", "number", "bigint"], [file_id, groupname, ordering, 0, i, null, null, 0n])
          //let name_length = Module.ccall("get_link_name_length", "number", ["bigint", "string", "bigint"], [file_id, groupname, i]);
          let name = Module._malloc(Number(name_length + 1));
          Module.ccall("H5Lget_name_by_idx", "number", ["bigint", "string", "number", "number", "bigint", "bigint", "number", "bigint"], [file_id, groupname, ordering, 0, i, name, name_length + 1, 0n])

          //Module.ccall("get_link_name", null, ["bigint", "string", "bigint", "number", "number"], [file_id, groupname, i, name_length, name]);
          //console.log(name, name_length);
          let name_str = decoder.decode(Module.HEAP8.buffer.slice(name, name + name_length));
          Module._free(name);
          keys.push(name_str);
        }
        return keys;

      }
      function get_attr(file, obj_name, attr_name) {
        let attrs_metadata = Module.get_attrs_metadata(file, obj_name);
        let metadata = attrs_metadata[attr_name];
        let data = Module.get_attribute_data(file, obj_name, attr_name);
        if (metadata.typestr == "string") {
          return data;
        }
        else if (metadata.typestr == "int") {
          let accessor = (metadata.signed) ? "Int" : "Uint";
          accessor += ((metadata.size) * 8).toFixed() + "Array";
          return new globalThis[accessor](data.buffer);

        }
        else if (metadata.typestr == "float") {
          let accessor = "Float" + ((metadata.size) * 8).toFixed() + "Array";
          return new globalThis[accessor](data.buffer);
        }
      }

      class Attributes extends Object {
        Symbol
      }
    </script>
    <script async src="webhdf5.js"></script>
    <script>
      Module.onRuntimeInitialized = _ => {
        alert("Initialised wasm module");
         const init = Module.cwrap("H5open", "number");
         init();
         console.log("libHDF5 initialized");
      };
    </script>
  </body>
</html>
